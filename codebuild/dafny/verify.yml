version: 0.2
phases:
  install:
    commands:
      - cd ..
      # Get Boogie
      - git clone --branch per-assert-splitting https://github.com/robin-aws/boogie.git
      - nuget restore boogie/Source/Boogie.sln
      - msbuild boogie/Source/Boogie.sln
      # Get Dafny
      - git clone --branch fine-grained-verification-logging https://github.com/robin-aws/dafny.git
      # Apply the patch for Dafny to use the local Boogie clone
      - cd dafny
      - git apply customBoogie.patch
      # Build Dafny
      - dotnet build Source/Dafny.sln
      - export PATH="$PWD/dafny/Binaries:$PATH"
      # Get Z3
      - make z3-ubuntu
      - cd aws-encryption-sdk-dafny
  build:
    commands:
      # Currently, test depends on src, so verifying test will also verify src
      - dotnet build -t:VerifyDafny -p:TestVerifyOverride="verificationLogger:trx" test
      - MAX_VERIFICATION_DURATION_SECONDS=120 python3 verification-times-from-trx.py test/TestResults/*.trx
reports:
    Dafny:
        file-format: VisualStudioTrx
        files:
            - '**/*'
        base-directory: 'test/TestResults'
